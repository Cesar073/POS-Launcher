name: Build and Release Launcher

permissions:
  contents: write

on:
  push:
    branches:
      - main
env:
  PYTHON_VERSION: '3.11'

jobs:
# =========================
# WINDOWS
# =========================
  build-windows:
    name: Build Launcher Windows
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
 
      - name: Clone source repositories
        shell: bash
        run: |
          git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/Cesar073/POS-Launcher.git

          mkdir workspace
          mkdir -p workspace/build
          mkdir -p workspace/launcher
          cp -r POS-Launcher/build/* workspace/build/
          cp -r POS-Launcher/launcher/* workspace/launcher/
          cp POS-Launcher/requirements*.txt workspace/
          cp POS-Launcher/launcher/main.py workspace/main.py

      - name: Read version and changelog from code
        id: get_version
        shell: pwsh
        run: |
          $file = "workspace/launcher/resources/version.py"
          if (Test-Path $file) {
            $content = Get-Content $file -Raw
            
            # Leer versión
            if ($content -match '__version__ = "([^"]+)"') {
              $version = $matches[1]
              Write-Host "Version found: $version"
              echo "version=$version" >> $env:GITHUB_OUTPUT
            } else {
              Write-Error "No se pudo encontrar la versión en $file"
              exit 1
            }
            
            # Leer changelog (puede estar en formato triple quotes o simple)
            $changelog = ""
            # Buscar triple comillas (multilinea)
            if ($content -match '__changelog__\s*=\s*"""([\s\S]*?)"""') {
              $changelog = $matches[1].Trim()
            } 
            # Si no hay triple comillas, buscar comillas simples (una línea)
            elseif ($content -match '__changelog__\s*=\s*"([^"]*)"') {
              $changelog = $matches[1].Trim()
            }
            
            if ($changelog) {
              Write-Host "Changelog found (length: $($changelog.Length) chars)"
              # Escapar caracteres especiales para GitHub Actions
              $changelog = $changelog -replace "`n", "`n" -replace "`r", ""
              # Guardar en archivo temporal para evitar problemas con caracteres especiales
              $changelog | Out-File -FilePath "changelog.txt" -Encoding utf8 -NoNewline
              $changelogBase64 = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($changelog))
              echo "changelog_base64=$changelogBase64" >> $env:GITHUB_OUTPUT
            } else {
              Write-Host "No changelog found, using default"
              $defaultChangelog = "Release automático generado desde commit ${{ github.sha }}`n`n**Versión:** $version"
              $defaultBase64 = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($defaultChangelog))
              echo "changelog_base64=$defaultBase64" >> $env:GITHUB_OUTPUT
            }
          } else {
            Write-Error "Archivo no encontrado: $file"
            exit 1
          }

      - name: Check if release exists
        id: check_release
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $tag = "v$version"
          Write-Host "Checking if tag $tag exists..."
          
          $headers = @{
            "Authorization" = "token ${{ secrets.GITHUB_TOKEN }}"
            "Accept" = "application/vnd.github.v3+json"
          }
          
          try {
            $response = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/tags/$tag" -Headers $headers -Method Get -ErrorAction Stop
            Write-Host "Release $tag already exists. Skipping build."
            echo "exists=true" >> $env:GITHUB_OUTPUT
          } catch {
            if ($_.Exception.Response.StatusCode -eq 404) {
              Write-Host "Release $tag does not exist. Proceeding with build."
              echo "exists=false" >> $env:GITHUB_OUTPUT
            } else {
              Write-Error "Error checking release: $_"
              exit 1
            }
          }

      - uses: actions/setup-python@v5
        if: steps.check_release.outputs.exists == 'false'
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependency Walker (Nuitka)
        if: steps.check_release.outputs.exists == 'false'
        shell: pwsh
        run: |
          Invoke-WebRequest https://dependencywalker.com/depends22_x86.zip -OutFile depends.zip
          Expand-Archive depends.zip C:\depends -Force
          echo "C:\depends" >> $env:GITHUB_PATH

      - name: Install Python dependencies
        if: steps.check_release.outputs.exists == 'false'
        working-directory: workspace
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-build.txt
          pip install -r requirements.txt

      - name: Build Launcher
        if: steps.check_release.outputs.exists == 'false'
        working-directory: workspace
        run: python build/build_launcher.py

      - name: Copy executable for release
        if: steps.check_release.outputs.exists == 'false'
        shell: pwsh
        run: |
          Copy-Item workspace/dist/Launcher_Windows.exe -Destination POS_Launcher_Windows.exe
          Write-Host "Executable copied to: POS_Launcher_Windows.exe"

      - name: Decode changelog
        if: steps.check_release.outputs.exists == 'false'
        id: decode_changelog
        shell: pwsh
        run: |
          $changelogBase64 = "${{ steps.get_version.outputs.changelog_base64 }}"
          $changelogBytes = [Convert]::FromBase64String($changelogBase64)
          $changelog = [System.Text.Encoding]::UTF8.GetString($changelogBytes)
          # Guardar en archivo para usarlo en el siguiente paso
          $changelog | Out-File -FilePath "release_body.txt" -Encoding utf8 -NoNewline

      - name: GitHub Release (Windows)
        if: steps.check_release.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: v${{ steps.get_version.outputs.version }}
          body_path: release_body.txt
          files: |
            POS_Launcher_Windows.exe
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# # =========================
# # RASPBIAN
# # =========================
#   build-raspbian:
#     name: Build Raspbian
#     runs-on: ubuntu-latest
#     if: ${{ github.event.inputs.build_pos_raspbian == 'true' || github.event.inputs.build_launcher_raspbian == 'true' }}

#     steps:
#       - uses: actions/checkout@v4
#       - uses: actions/setup-python@v5
#         with:
#           python-version: ${{ env.PYTHON_VERSION }}

#       - name: Clone source repositories
#         run: |
#           git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/Cesar073/pos_gui.git src/pos_gui
#           git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/Cesar073/Point_of_Sale.git src/pos_core
#           git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/Cesar073/pos_repository.git src/pos_repository

#           mkdir workspace
#           cp -r src/pos_gui workspace/pos_gui
#           cp -r src/pos_core workspace/pos_core
#           cp -r src/pos_repository workspace/repository
#           cp -r build launcher workspace/
#           cp requirements*.txt workspace/
#           cp src/pos_gui/main.py workspace/main.py

#       - name: Install deps
#         working-directory: workspace
#         run: |
#           pip install -r requirements-build.txt
#           pip install -r requirements.txt

#       - name: Build POS (Raspbian)
#         if: ${{ github.event.inputs.build_pos_raspbian == 'true' }}
#         working-directory: workspace
#         run: python build/rpi/build_rpi.py

#       - name: Build Launcher (Raspbian)
#         if: ${{ github.event.inputs.build_launcher_raspbian == 'true' }}
#         working-directory: workspace
#         run: python build/rpi/build_launcher.py

#       - name: Package POS (Raspbian)
#         if: ${{ github.event.inputs.build_pos_raspbian == 'true' }}
#         run: tar -czf POS-Raspbian-v${{ github.event.inputs.version }}.tar.gz -C workspace/dist POS

#       - name: Copy Launcher binary
#         if: ${{ github.event.inputs.build_launcher_raspbian == 'true' }}
#         shell: pwsh
#         run: cp workspace/dist/POS_Launcher_Raspbian .

# # =========================
# # LINUX
# # =========================
#   build-linux:
#     name: Build Linux
#     runs-on: ubuntu-latest
#     if: ${{ github.event.inputs.build_pos_linux == 'true' || github.event.inputs.build_launcher_linux == 'true' }}

#     steps:
#       - uses: actions/checkout@v4
#       - uses: actions/setup-python@v5
#         with:
#           python-version: ${{ env.PYTHON_VERSION }}

#       - name: Clone source repositories
#         run: |
#           git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/Cesar073/pos_gui.git src/pos_gui
#           git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/Cesar073/Point_of_Sale.git src/pos_core
#           git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/Cesar073/pos_repository.git src/pos_repository

#           mkdir workspace
#           cp -r src/pos_gui workspace/pos_gui
#           cp -r src/pos_core workspace/pos_core
#           cp -r src/pos_repository workspace/repository
#           cp -r build launcher workspace/
#           cp requirements*.txt workspace/
#           cp src/pos_gui/main.py workspace/main.py

#       - name: Install deps
#         working-directory: workspace
#         run: |
#           pip install -r requirements-build.txt
#           pip install -r requirements.txt

#       - name: Build POS (Linux)
#         if: ${{ github.event.inputs.build_pos_linux == 'true' }}
#         working-directory: workspace
#         run: python build/linux/build_linux.py

#       - name: Build Launcher (Linux)
#         if: ${{ github.event.inputs.build_launcher_linux == 'true' }}
#         working-directory: workspace
#         run: python build/linux/build_launcher.py

#       - name: Package POS (Linux)
#         if: ${{ github.event.inputs.build_pos_linux == 'true' }}
#         run: tar -czf POS-Linux-v${{ github.event.inputs.version }}.tar.gz -C workspace/dist POS

#       - name: Copy Launcher binary
#         if: ${{ github.event.inputs.build_launcher_linux == 'true' }}
#         shell: pwsh
#         run: cp workspace/dist/POS_Launcher_Linux .
